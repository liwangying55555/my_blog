---
title: ä»å…¥é—¨åˆ°æ”¾å¼ƒ(å››)ã€å…‹é‡Œé‡‘æ³•ã€‘
order: 4
date: 2024-12-30 14:40:40
# cover: /assets/bg/bg3.jpg
# article: true
# star: false
category: 
    - Cesium
---

<!-- @format -->
## å¥‘æœº&&å¼€å§‹

è¿™æ˜¯ä¸€ä¸ªæœ¬æ¥ä¸å±äºæˆ‘çš„æ´»ï¼Œç”±äºå¦ä¸€ä¸ªåŒäº‹ç ”ç©¶äº†å¾ˆä¹…ï¼Œé€‰æ‹©äº†ä¸€ä¸ªè€æ¿ä¸æ»¡æ„çš„æ–¹å‘ï¼Œå¯¼è‡´å¤±å»äº†è¿™ä¸ªã€å¤§å¥½æœºä¼šã€‘ï¼Œå› æ­¤ï¼Œæ´»å„¿å°±è½åˆ°äº†æˆ‘å¤´ä¸Šäº†ğŸ˜…

éœ€è¦å®ç°çš„æ•ˆæœæ˜¯ä¸€ä¸ªåˆ«å®¶çš„ç½‘ç«™åœ°å›¾`mapBox`ï¼Œé€šè¿‡å…‹é‡Œé‡‘æ’å€¼å®ç°å‡ºæ¥çš„æ²³æµçš„æ¸å˜æ•ˆæœã€‚

![æ•ˆæœæ ·æœ¬](./imgs/æ•ˆæœæ ·æœ¬.png)

çœ‹ç€å…¶å®æœ‰ç‚¹æ— ä»ä¸‹æ‰‹ï¼Œæ¯•ç«Ÿè¿™ä¸ªåœ°å›¾æˆ‘ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼çš„ï¼Œä½†æ˜¯å¹¸å¥½ï¼Œæ„Ÿè°¢ç°åœ¨çš„jsæ··æ·†æŠ€æœ¯ï¼Œå…³äºæŸä¸ªå›ºå®šçš„apiåç§°æˆ–è€…æŸäº›å¸¸é‡ï¼Œæ˜¯ä¸ä¼šè¿›è¡Œæ··æ·†çš„ï¼Œä»ä»–ä»¬å®¶çš„æºç ä¸­ï¼Œé€æ­¥åˆ†æå‡ºæ¥äº†ä»–ä»¬ä½¿ç”¨çš„æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¹‹å‰ä»æœªå¬è¿‡çš„å…‹é‡Œé‡‘æ’å€¼ã€‚

æ²¡åŠæ³•ï¼Œè®©æˆ‘ä»¬æŒ‰å›¾ç´¢éª¥ï¼Œå…¶å®åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯æ¯”å¦‚è¿™ä¸€æ®µæ²³æµä¸Šéšæœºåˆ†å¸ƒç€10ä¸ªç›‘æµ‹ç«™ç‚¹ï¼Œæ¯ä¸ªç«™ç‚¹åœ¨ä¸åŒæ—¶åˆ»æ£€æµ‹åˆ°çš„æ°´è´¨éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ç§æ°´è´¨çš„å˜åŒ–é€šè¿‡ç»™æ²³æµä¸Šè‰²ï¼Œæ¥è¡¨ç°å‡ºæ¥ã€‚

åœ¨è¿™é‡Œï¼Œå°±æœ‰äº†ä¸€ä¸ªåŸºç¡€ï¼Œâ€œç¦»æ•£ç‚¹â€ã€â€œéšæœºæ•°â€ã€â€œç©ºé—´æ¦‚å¿µâ€ã€‚

## ä»€ä¹ˆæ˜¯å…‹é‡Œé‡‘æ³•

åœ¨è¿™é‡Œï¼Œä½œä¸ºä»æœªæ¥è§¦è¿‡è¿™ä¸ªæ¦‚å¿µçš„æˆ‘æ¥è¯´ï¼Œç•¥æ˜¾æ‡µé€¼ï¼Œäºæ˜¯ç™¾åº¦å¾—åˆ°çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š

> å…‹é‡Œé‡‘æ³•ï¼ˆKrigingï¼‰æ˜¯ä¾æ®åæ–¹å·®å‡½æ•°å¯¹éšæœºè¿‡ç¨‹/éšæœºåœºè¿›è¡Œç©ºé—´å»ºæ¨¡å’Œé¢„æµ‹ï¼ˆæ’å€¼ï¼‰çš„å›å½’ç®—æ³• ã€‚åœ¨ç‰¹å®šçš„éšæœºè¿‡ç¨‹ï¼Œä¾‹å¦‚å›ºæœ‰å¹³ç¨³è¿‡ç¨‹ä¸­ï¼Œå…‹é‡Œé‡‘æ³•èƒ½å¤Ÿç»™å‡ºæœ€ä¼˜çº¿æ€§æ— åä¼°è®¡ï¼ˆBest Linear Unbiased Prediction, BLUPï¼‰ï¼Œå› æ­¤åœ¨åœ°ç»Ÿè®¡å­¦ä¸­ä¹Ÿè¢«ç§°ä¸ºç©ºé—´æœ€ä¼˜æ— åä¼°è®¡å™¨ï¼ˆspatial BLUPï¼‰ã€‚

>å¯¹å…‹é‡Œé‡‘æ³•çš„ç ”ç©¶å¯ä»¥è¿½æº¯è‡³äºŒåä¸–çºª60å¹´ä»£ï¼Œå…¶ç®—æ³•åŸå‹è¢«ç§°ä¸ºæ™®é€šå…‹é‡Œé‡‘ï¼ˆOrdinary Kriging, OKï¼‰ï¼Œå¸¸è§çš„æ”¹è¿›ç®—æ³•åŒ…æ‹¬æ³›å…‹é‡Œé‡‘ï¼ˆUniversal Kriging, UKï¼‰ã€ååŒå…‹é‡Œé‡‘ï¼ˆCo-Kriging, CKï¼‰å’Œæå–å…‹é‡Œé‡‘ï¼ˆDisjunctive Kriging, DKï¼‰ ï¼›å…‹é‡Œé‡‘æ³•èƒ½å¤Ÿä¸å…¶å®ƒæ¨¡å‹ç»„æˆæ··åˆç®—æ³•ã€‚

>è‹¥åæ–¹å·®å‡½æ•°çš„å½¢å¼ç­‰ä»·ï¼Œä¸”å»ºæ¨¡å¯¹è±¡æ˜¯å¹³ç¨³é«˜æ–¯è¿‡ç¨‹ï¼Œæ™®é€šå…‹é‡Œé‡‘çš„è¾“å‡ºä¸é«˜æ–¯è¿‡ç¨‹å›å½’ï¼ˆGaussian Process Regression, GPRï¼‰åœ¨æ­£æ€ä¼¼ç„¶ä¸‹è¾“å‡ºçš„å‡å€¼å’Œç½®ä¿¡åŒºé—´ç›¸åŒï¼Œæœ‰ç¨³å®šçš„é¢„æµ‹æ•ˆæœã€‚å…‹é‡Œé‡‘æ³•æ˜¯å…¸å‹çš„åœ°ç»Ÿè®¡å­¦ç®—æ³•ï¼Œè¢«åº”ç”¨äºåœ°ç†ç§‘å­¦ã€ç¯å¢ƒç§‘å­¦ã€å¤§æ°”ç§‘å­¦ç­‰é¢†åŸŸ ã€‚

äºæ˜¯ï¼Œå¯èƒ½æ›´æ‡µé€¼äº†ã€‚

æœ€åï¼Œçœ‹äº†ç½‘ä¸Šå…³äºåœ¨cesiumä¸­ä½¿ç”¨å…‹é‡Œé‡‘æ’å€¼çš„ä½¿ç”¨ï¼Œå¤§æ¦‚çŸ¥é“äº†å‡ ç‚¹æ¯”è¾ƒé‡è¦çš„æ¡ä»¶ï¼š

- éœ€è¦å¤§äº4ä¸ªç¦»æ•£ç‚¹ï¼Œç‚¹çš„ç»çº¬åº¦å’Œç‚¹çš„æ•°å€¼
- éœ€è¦ä¸€ä¸ªç©ºé—´èŒƒå›´ï¼Œå¯ä»¥æ˜¯å½“å‰ç¦»æ•£ç‚¹çš„è¾¹ç•Œ

åœ¨jsä¸­ï¼Œå…‹é‡Œé‡‘æ³•æœ‰å¼€æºçš„ç®—æ³•`kriging.js`ï¼Œæˆ‘ä»¬åœ¨å®ç°ä¸­å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº“ã€‚

[https://github.com/oeo4b/kriging.js](https://github.com/oeo4b/kriging.js)

## æŒ‰å›¾ç´¢éª¥

æœ‰äº†è¿™äº›ï¼Œä½†å¯¹åº”ç€æºç æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“äº†ï¼Œæ€ä¹ˆè®¡ç®—å‡ºä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„èŒƒå›´å†…çš„å…‹é‡Œé‡‘æ’å€¼ã€‚

å‡è®¾åœ¨èŒƒå›´å†…æœ‰æ˜¯Nä¸ªç¦»æ•£ç‚¹ï¼Œæ¯ä¸ªç¦»æ•£ç‚¹çš„æ•°å€¼å¦‚ä¸‹ï¼š

```js
// ç¤ºä¾‹ç‚¹æ•°æ®
const dotList = [
    { lon: 110.22, lat: 30.7, value: 10 },
    ...
]

// æ•°å€¼å¯¹åº”çš„é¢œè‰²æ•°æ®
const colors = [
    { min: 0, max: 5, color: "#A9F08E" }, 
    { min: 5, max: 10, color: "#72D66B" }, 
    { min: 10, max: 25, color: "#3DB83D" }, 
    { min: 25, max: 50, color: "#61B7FC" }, 
    { min: 50, max: 100, color: "#0001FE" }, 
    { min: 100, max: 250, color: "#FD00FA" }, 
    { min: 250, max: 1000, color: "#7F013E" }, 
];

// èŒƒå›´çš„è¾¹ç•Œæ•°æ®
const czExt = {
  xmin: 110.250794,
  ymin: 29.934982,
  xmax: 112.076927,
  ymax: 31.571019,
  xNum: 365,
};
```

æˆ‘ä»¬éœ€è¦ç”¨è¿™äº›æ•°æ®ï¼Œè®¡ç®—å‡ºä¸€ä¸ªå…‹é‡Œé‡‘æ’å€¼

```js
// è·å–æ•°æ®çš„å…‹é‡Œé‡‘æ’å€¼
export function getKrigingGisData(data) {
  let siteVas = [];
  let lons = [];
  let lats = [];
  const bounds = czExt;

  let gridResult = [];

  let ext = [
    [
      [bounds.xmin, bounds.ymin],
      [bounds.xmax, bounds.ymin],
      [bounds.xmax, bounds.ymax],
      [bounds.xmin, bounds.ymax],
    ],
  ];

  for (let s of data) {
    if (
      s.lon &&
      s.lat &&
      !isNaN(parseFloat(s.lon)) &&
      !isNaN(parseFloat(s.lat)) &&
      s.value &&
      parseFloat(s.lon) > bounds.xmin &&
      parseFloat(s.lon) < bounds.xmax &&
      parseFloat(s.lat) > bounds.ymin &&
      parseFloat(s.lat) < bounds.ymax
    ) {
      siteVas.push(s.value);
      lons.push(parseFloat(s.lon));
      lats.push(parseFloat(s.lat));
    }
  }
  if (siteVas.length > 3) {
   // ä½¿ç”¨gaussianã€exponentialæˆ–sphericalæ¨¡å‹å¯¹æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªvariogramå¯¹è±¡ã€‚
   // 0å¯¹åº”é«˜æ–¯è¿‡ç¨‹çš„æ–¹å·®å‚æ•°ï¼Œä¸€èˆ¬è®¾ç½®ä¸º 0ã€‚
   // 100å¯¹åº”æ–¹å·®å‡½æ•°çš„å…ˆéªŒå€¼ï¼Œé»˜è®¤è®¾ç½®ä¸º100
    let model = kriging.train(
      siteVas,
      lons,
      lats,
      'spherical',
      0,
      100
    );

    // ä½¿ç”¨trainè¿”å›çš„variogramå¯¹è±¡ä½¿extæè¿°çš„åœ°ç†ä½ç½®å†…çš„æ ¼ç½‘å…ƒç´ å…·å¤‡ä¸ä¸€æ ·çš„é¢„æµ‹å€¼
    // (bounds.xmax - bounds.xmin) / bounds.xNumçš„bounds.xNumæ˜¯è¿”å›çš„ç½‘æ ¼æ•°é‡,è¶Šå¤§è¶Šç»†å¤„ç†è¶Šæ…¢
    gridResult = kriging.grid(
      ext,
      model,
      (bounds.xmax - bounds.xmin) / bounds.xNum
    );
  } else {
    gridResult = [];
  }
  // å¾—åˆ°ä¸€ä¸ªå…‹é‡Œé‡‘æ’å€¼grid
  return gridResult;
}
```

ä¸€èˆ¬çš„å¸¸è§„åšæ³•æ˜¯ä½¿ç”¨è¿™ä¸ªå¾—åˆ°çš„gridç½‘æ ¼ï¼Œæ¸²æŸ“åˆ°canvasä¸Šé¢ï¼Œå†æŠŠè¿™ä¸ªcanvasç”¨è´´å›¾æè´¨çš„æ–¹å¼æ¸²æŸ“åˆ°cesiumå›¾å±‚ä¸Šï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬æœ‰ç‚¹ä¸ä¸€æ ·çš„æ˜¯ï¼Œä½œä¸ºæ²³æµçš„jsonæ¥è¯´ï¼Œå®ƒçš„é¢ç‰‡æ˜¯åˆ†æ•£ï¼Œè€Œä¸”éƒ¨åˆ†æ²³æµä¸æ˜¯`Polygon`ã€`MultiPolygon`ï¼Œè€Œæ˜¯`LineString`ã€`MultiLineString`ã€‚

è€Œåœ¨Cesiumä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»˜åˆ¶å‡ºæ¸å˜è‰²çš„æ²³æµï¼Œå…¨éƒ¨çš„æ²³æµæ˜¯é¢+çº¿çš„ç»„åˆå±•ç¤ºã€‚

é‰´äºæˆ‘ä»¬è¦åšçš„æ˜¯å¤åˆ»åˆ«äººå®¶çš„åœ°å›¾çš„å®ç°æ–¹å¼ï¼Œå› æ­¤æ•°æ®æ¥æºjsonæ˜¯æœ‰è‡ªå¸¦ç¦»æ•£æŒ‡æ•°ï¼Œæˆ‘ä»¬æ ¹æ®ç½‘æ ¼gridè·å–æ¯ä¸€æ®µæ•°æ®çš„æ•°æ®ï¼Œå†æ ¹æ®æ•°å€¼è·å–å¯¹åº”çš„é¢œè‰²ï¼Œå°±å¯ä»¥è·å–å¯¹åº”çš„æ¯ä¸€å°æ®µjsonæ•°æ®çš„é¢œè‰²ï¼Œå¹¶ä¸”è¿›è¡Œç»˜åˆ¶ã€‚

é‰´äºä¸æ˜¯å‰ç«¯å•ç‹¬å®ç°ï¼Œè¿˜ä¼šjsonçº§åˆ«çš„åå°å¤„ç†ï¼Œå› æ­¤ï¼Œè¯¥æ–¹æ³•åªå¯ä»¥å€Ÿé‰´ã€‚

```js
// æ ¹æ®æ’å€¼è®¡ç®—è‰²å—
const dealGridColor = (gridResult, properties) => {
  if (gridResult[properties.R] && gridResult[properties.R][properties.C]) {
    let a = gridResult[properties.R][properties.C];
    return getColor(a * 10);
  } else {
    return riverColor;
  }
};

// ç»˜åˆ¶æ²³æµé¢
export const drawRiverLayer = async (gridResult) => {
  NormalPoi.addDot({
    name: "river_layer_polygon",
    list: riverJson.features,
    renderPolygon: (item) => {
      const lonLatArr = item.geometry.coordinates.flat(3);
      // æ ¹æ®æ’å€¼è®¡ç®—è‰²å—
      const color = dealGridColor(gridResult, item.properties);
      return {
        polygon: {
          hierarchy: Cesium.Cartesian3.fromDegreesArray(lonLatArr),
          material: Cesium.Color.fromCssColorString(color),
        },
      };
    },
  });
};
// ç»˜åˆ¶æ²³æµçº¿
export const drawRiverLine = (gridResult) => {
  NormalPoi.addDot({
    name: "river_layer_line",
    list: riverLineJson.features,
    renderPolygon: (item) => {
      const lonLatArr = item.geometry.coordinates.flat(3);
      // æ ¹æ®æ’å€¼è®¡ç®—è‰²å—
      const color = dealGridColor(gridResult, item.properties);
      return {
        polyline: {
          positions: Cesium.Cartesian3.fromDegreesArray(lonLatArr),
          material: Cesium.Color.fromCssColorString(color),
          width: item.properties.DISPCLASS || 2, // DISPCLASS æ²³æµå®½åº¦
        },
      };
    },
  });
};
```

## kriging.jsä½¿ç”¨æ–¹æ³•è§£æ

```js
kriging.train ( siteValue, lngs, lats, â€˜exponentialâ€™, 0, 100 );
```

ä½¿ç”¨gaussianã€exponentialæˆ–sphericalæ¨¡å‹å¯¹æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªvariogramå¯¹è±¡ã€‚
0å¯¹åº”é«˜æ–¯è¿‡ç¨‹çš„æ–¹å·®å‚æ•°ï¼Œä¸€èˆ¬è®¾ç½®ä¸º 0ã€‚
100å¯¹åº”æ–¹å·®å‡½æ•°çš„å…ˆéªŒå€¼ï¼Œé»˜è®¤è®¾ç½®ä¸º100ã€‚

```js
kriging.grid ( ex, variogram, (maxy - miny) / 500 );
```

ä½¿ç”¨trainè¿”å›çš„variogramå¯¹è±¡ä½¿exæè¿°çš„åœ°ç†ä½ç½®å†…çš„æ ¼ç½‘å…ƒç´ å…·å¤‡ä¸ä¸€æ ·çš„é¢„æµ‹å€¼ã€‚
(maxy - miny) / 500çš„500æ˜¯è¿”å›çš„ç½‘æ ¼æ•°é‡,è¶Šå¤§è¶Šç»†å¤„ç†è¶Šæ…¢ã€‚

```js
kriging.plot ( canvas, grid, [minx, maxx], [miny, maxy], colors );
```

å°†å¾—åˆ°çš„æ ¼ç½‘gridæ¸²æŸ“è‡³canvasä¸Šã€‚
è¿™é‡Œæˆ‘ä»¬æ›´æ”¹äº†plotæ–¹æ³•çš„è‰²å½©èµ‹å€¼ï¼Œæ›´æ”¹åå°±å¯ä»¥æ ¹æ®æ•°æ®èŒƒå›´èµ‹äºˆè‡ªå®šä¹‰çš„è‰²å½©äº†ã€‚
